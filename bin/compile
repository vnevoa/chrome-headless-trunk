#!/bin/bash

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

echo "BUILD_DIR = $BUILD_DIR"
echo "CACHE_DIR = $CACHE_DIR"
echo "ENV_DIR = $ENV_DIR"

echo "-----> Install dependency deb packages"
apt-get update -qqy \
  && apt-get -qqy install libnss3 libnss3-tools libfontconfig1 wget ca-certificates apt-transport-https inotify-tools unzip \
  libpangocairo-1.0-0 libx11-xcb-dev libxcomposite-dev libxcursor1 libxdamage1 libxi6 libgconf-2-4 libxtst6 libcups2-dev \
  libxss-dev libxrandr-dev libasound2-dev libatk1.0-dev libgtk-3-dev ttf-ancient-fonts chromium-codecs-ffmpeg-extra libappindicator3-1 \
  && rm -rf /var/lib/apt/lists/* /var/cache/apt/*

echo "-----> Install dumb-init package"
cd $BUILD_DIR
wget https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb \
	&& dpkg -i dumb-init_*.deb \
	&& rm dumb-init_1.2.0_amd64.deb

echo "-----> Install chromium-linux"
cd $BUILD_DIR
REV=775629
wget -q -O chrome.zip https://commondatastorage.googleapis.com/chromium-browser-snapshots/Linux_x64/$REV/chrome-linux.zip \
  && unzip chrome.zip \
  && rm chrome.zip

echo "-----> Check chromium-linux version"
$PWD/chrome-linux/chrome --version

echo "-----> Exporting PATH" | indent
PROFILE_PATH="$BUILD_DIR/.profile.d/chrome.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="/app/chrome-linux:$PATH"' >> $PROFILE_PATH

# ln -s $PWD/chrome-linux/chrome /usr/bin/google-chrome-unstable
# cp start.sh /usr/bin/
# cp import_cert.sh /usr/bin/
# mkdir /data
# HOME=/data
# DEBUG_ADDRESS=0.0.0.0
# DEBUG_PORT=9222
# ENTRYPOINT ["/usr/bin/dumb-init", "--"]
# CMD ["/usr/bin/start.sh"]
